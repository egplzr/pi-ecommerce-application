<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Perfil</title>
    <!-- Link para o Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .profile-container {
            max-width: 900px;
            margin: 30px auto;
            background-color: white;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .btn-custom {
            background-color: #e60012;
            color: white;
        }

        .btn-custom:hover {
            background-color: #c4000d;
            color: white;
        }

        .nav-pills .nav-link.active {
            background-color: #e60012;
        }

        .address-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
            position: relative;
        }

        .address-card.default {
            border-color: #e60012;
            border-width: 2px;
        }

        .address-badge {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .address-actions {
            position: absolute;
            bottom: 10px;
            right: 10px;
        }

        .alert {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>

<body>
<!-- Cabeçalho com padrão Mc Donalds -->
<header class="p-3 rounded mb-4" style="background-color: #DA291C;">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <h1 style="color: #FFC72C;">
                <a href="/loja" style="color: inherit; text-decoration: none;">
                    <img src="/static/images/m-mcdonalds-removebg-preview.png" alt="Logo Mc Donalds"
                         style="width:40px; height:auto; vertical-align: middle;" class="me-2">
                    Mc Donalds
                </a>
            </h1>
            <div>
                <a href="/loja/perfil" class="btn btn-outline-light me-2">
                    <i class="bi bi-person-fill me-1"></i> Meu Perfil
                </a>
                <a href="/loja/carrinho" class="btn btn-warning me-2">
                    <i class="bi bi-cart-fill me-1"></i> Carrinho
                    <span class="badge bg-dark ms-1" id="cartItemCount">0</span>
                </a>
                <button class="btn btn-outline-light" onclick="fazerLogout()">
                    <i class="bi bi-box-arrow-right me-1"></i> Sair
                </button>
            </div>
        </div>
    </div>
</header>

<div class="profile-container p-4">
    <!-- Alertas -->
    <div class="alert alert-success" id="successAlert" role="alert">
        <i class="bi bi-check-circle me-2"></i> <span id="successMessage">Operação realizada com sucesso!</span>
    </div>
    <div class="alert alert-danger" id="errorAlert" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i> <span id="errorMessage">Erro ao realizar operação.</span>
    </div>

    <h2 class="mb-4">Meu Perfil</h2>

    <!-- Navegação por abas -->
    <ul class="nav nav-pills mb-4" id="profileTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="dados-tab" data-bs-toggle="tab" data-bs-target="#dados" type="button"
                    role="tab" aria-controls="dados" aria-selected="true">Dados Pessoais</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="enderecos-tab" data-bs-toggle="tab" data-bs-target="#enderecos"
                    type="button" role="tab" aria-controls="enderecos" aria-selected="false">Endereços</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="senha-tab" data-bs-toggle="tab" data-bs-target="#senha" type="button"
                    role="tab" aria-controls="senha" aria-selected="false">Alterar Senha</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="meusPedidos-tab" data-bs-toggle="tab" data-bs-target="#pedidos" type="button"
                    role="tab" aria-controls="pedidos" aria-selected="false">Meus Pedidos</button>
        </li>
    </ul>

    <div class="tab-content" id="profileTabsContent">
        <!-- Aba de Dados Pessoais -->
        <div class="tab-pane fade show active" id="dados" role="tabpanel" aria-labelledby="dados-tab">
            <form id="formDados">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="nome" class="form-label">Nome Completo</label>
                        <input type="text" class="form-control" id="nome" required>
                    </div>
                    <div class="col-md-6">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" disabled>
                        <div class="form-text">O email não pode ser alterado.</div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="cpf" class="form-label">CPF</label>
                        <input type="text" class="form-control" id="cpf" disabled>
                        <div class="form-text">O CPF não pode ser alterado.</div>
                    </div>
                    <div class="col-md-6">
                        <label for="dataNascimento" class="form-label">Data de Nascimento</label>
                        <input type="date" class="form-control" id="dataNascimento">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="genero" class="form-label">Gênero</label>
                        <select class="form-control" id="genero">
                            <option value="">Selecione</option>
                            <option value="MASCULINO">Masculino</option>
                            <option value="FEMININO">Feminino</option>
                            <option value="OUTRO">Outro</option>
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn btn-custom">Salvar Alterações</button>
            </form>
        </div>

        <!-- Aba de Endereços -->
        <div class="tab-pane fade" id="enderecos" role="tabpanel" aria-labelledby="enderecos-tab">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4>Meus Endereços</h4>
                <button type="button" class="btn btn-custom" data-bs-toggle="modal"
                        data-bs-target="#modalNovoEndereco">
                    <i class="bi bi-plus-circle me-2"></i>Novo Endereço
                </button>
            </div>

            <div id="listaEnderecos" class="row">
                <!-- Os endereços serão carregados dinamicamente -->
                <div class="col-12 text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba de Alterar Senha -->
        <div class="tab-pane fade" id="senha" role="tabpanel" aria-labelledby="senha-tab">
            <form id="formSenha">
                <div class="mb-3">
                    <label for="senhaAtual" class="form-label">Senha Atual</label>
                    <input type="password" class="form-control" id="senhaAtual" required>
                </div>
                <div class="mb-3">
                    <label for="novaSenha" class="form-label">Nova Senha</label>
                    <input type="password" class="form-control" id="novaSenha" required minlength="6">
                    <div class="form-text">A senha deve ter pelo menos 6 caracteres.</div>
                </div>
                <div class="mb-3">
                    <label for="confirmarSenha" class="form-label">Confirmar Nova Senha</label>
                    <input type="password" class="form-control" id="confirmarSenha" required minlength="6">
                </div>

                <button type="submit" class="btn btn-custom">Alterar Senha</button>
            </form>
        </div>

        <!-- Aba de Meus Pedidos -->
        <div class="tab-pane fade" id="pedidos" role="tabpanel" aria-labelledby="meusPedidos-tab">
            <div class="row mb-3">
                <div class="col-12 text-center" id="spinnerPedidos" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando pedidos...</span>
                    </div>
                </div>
                <div class="col-12 text-center text-muted" id="naoTemPedidos" style="display: none;">
                    <p>Você ainda não possui pedidos.</p>
                </div>
                <div class="col-12" id="conteudoPedidos" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th>Número do Pedido</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>Total (R$)</th>
                                <th>Ações</th>
                            </tr>
                            </thead>
                            <tbody id="corpoTabelaPedidos">
                            <!-- Linhas de pedidos serão injetadas aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Novo Endereço -->
<div class="modal fade" id="modalNovoEndereco" tabindex="-1" aria-labelledby="modalNovoEnderecoLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNovoEnderecoLabel">Novo Endereço</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="formNovoEndereco">
                    <div class="mb-3">
                        <label for="cep" class="form-label">CEP</label>
                        <input type="text" class="form-control" id="cep" placeholder="00000-000" required>
                    </div>
                    <div class="mb-3">
                        <label for="logradouro" class="form-label">Logradouro</label>
                        <input type="text" class="form-control" id="logradouro" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="numero" class="form-label">Número</label>
                            <input type="text" class="form-control" id="numero" required>
                        </div>
                        <div class="col-md-8">
                            <label for="complemento" class="form-label">Complemento</label>
                            <input type="text" class="form-control" id="complemento">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="bairro" class="form-label">Bairro</label>
                        <input type="text" class="form-control" id="bairro" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="cidade" class="form-label">Cidade</label>
                            <input type="text" class="form-control" id="cidade" required>
                        </div>
                        <div class="col-md-4">
                            <label for="uf" class="form-label">UF</label>
                            <input type="text" class="form-control" id="uf" required maxlength="2">
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="enderecoPadrao">
                        <label class="form-check-label" for="enderecoPadrao">
                            Definir como endereço padrão
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-custom" id="btnSalvarEndereco">Salvar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmação</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p id="mensagemConfirmacao">Tem certeza que deseja realizar esta operação?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="btnConfirmar">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Variável para evitar múltiplas requisições na aba “Meus Pedidos”
    let pedidosJaCarregados = false;

    // Função para verificar autenticação
    function verificarAutenticacao() {
        fetch('/api/cliente/auth/status')
            .then(response => response.json())
            .then(data => {
                if (!data.autenticado) {
                    // Redirecionar para a página de login se não estiver autenticado
                    window.location.href = '/loja/login-cliente';
                }
            })
            .catch(error => {
                console.error('Erro ao verificar autenticação:', error);
                window.location.href = '/loja/login-cliente';
            });
    }

    // Variáveis para manipulação dos modais
    let modalNovoEndereco = null;
    let modalConfirmacao = null;

    // Dados do cliente
    let dadosCliente = null;

    // Inicialização da página
    document.addEventListener('DOMContentLoaded', function () {
        verificarAutenticacao();
        // Inicializar modais
        modalNovoEndereco = new bootstrap.Modal(document.getElementById('modalNovoEndereco'));
        modalConfirmacao = new bootstrap.Modal(document.getElementById('modalConfirmacao'));

        // Carregar dados do cliente
        carregarDadosCliente();

        // Adicionar eventos aos formulários
        document.getElementById('formDados').addEventListener('submit', salvarDadosPessoais);
        document.getElementById('formSenha').addEventListener('submit', alterarSenha);
        document.getElementById('btnSalvarEndereco').addEventListener('click', salvarNovoEndereco);

        // Adicionar validação de CEP
        document.getElementById('cep').addEventListener('blur', buscarCep);

        // Quando a aba “Meus Pedidos” for exibida, dispara a busca
        document.getElementById('meusPedidos-tab')
            .addEventListener('shown.bs.tab', carregarMeusPedidos);
    });

    // Função para exibir mensagens de sucesso
    function mostrarSucesso(mensagem) {
        document.getElementById('successMessage').textContent = mensagem;
        document.getElementById('successAlert').style.display = 'block';
        document.getElementById('errorAlert').style.display = 'none';

        // Ocultar após 5 segundos
        setTimeout(() => {
            document.getElementById('successAlert').style.display = 'none';
        }, 5000);
    }

    // Função para exibir mensagens de erro
    function mostrarErro(mensagem) {
        document.getElementById('errorMessage').textContent = mensagem;
        document.getElementById('errorAlert').style.display = 'block';
        document.getElementById('successAlert').style.display = 'none';

        // Ocultar após 5 segundos
        setTimeout(() => {
            document.getElementById('errorAlert').style.display = 'none';
        }, 5000);
    }

    // Carregar dados do cliente
    function carregarDadosCliente() {
        fetch('/api/cliente/auth/status')
            .then(response => response.json())
            .then(data => {
                if (!data.autenticado) {
                    window.location.href = '/loja/login-cliente';
                    throw new Error('Sessão expirada');
                }
                return fetch('/api/cliente/perfil');
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/loja/login-cliente';
                        throw new Error('Usuário não autenticado');
                    }
                    return response.text().then(text => {
                        try {
                            const errorData = JSON.parse(text);
                            throw new Error(errorData.message || 'Erro desconhecido');
                        } catch {
                            throw new Error('Erro ao processar resposta: ' + text);
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                dadosCliente = data;
                preencherFormularioCliente(data);
                renderizarEnderecos(data.enderecosEntrega || []);
            })
            .catch(error => {
                console.error('Erro ao carregar dados do cliente:', error);
                try {
                    if (error.message) {
                        mostrarErro(error.message);
                    } else {
                        mostrarErro('Erro ao carregar seus dados. Por favor, tente novamente.');
                    }
                } catch {
                    mostrarErro('Erro ao carregar seus dados. Por favor, tente novamente.');
                }
            });
    }

    // Preenche os campos do formulário com os dados do cliente
    function preencherFormularioCliente(cliente) {
        document.getElementById('nome').value = cliente.nome || '';
        document.getElementById('email').value = cliente.email || '';
        document.getElementById('cpf').value = cliente.cpf || '';

        if (cliente.dataNascimento) {
            const data = new Date(cliente.dataNascimento);
            const dataFormatada = data.toISOString().split('T')[0];
            document.getElementById('dataNascimento').value = dataFormatada;
        }

        if (cliente.genero) {
            document.getElementById('genero').value = cliente.genero;
        }
    }

    // Renderizar lista de endereços
    function renderizarEnderecos(enderecos) {
        const listaEnderecos = document.getElementById('listaEnderecos');
        listaEnderecos.innerHTML = '';

        if (!enderecos || enderecos.length === 0) {
            listaEnderecos.innerHTML = `
                <div class="col-12 text-center py-4">
                    <p class="text-muted">Você ainda não possui endereços cadastrados.</p>
                </div>
            `;
            return;
        }

        enderecos.forEach((endereco, index) => {
            const isPadrao = index === 0;

            const enderecoCard = document.createElement('div');
            enderecoCard.className = 'col-md-6 mb-3';
            enderecoCard.innerHTML = `
                <div class="card address-card p-3 ${isPadrao ? 'default' : ''}">
                    ${isPadrao ? '<span class="badge bg-success address-badge">Padrão</span>' : ''}
                    <div class="card-body">
                        <p class="card-text">${endereco}</p>
                        <div class="address-actions">
                            ${!isPadrao ? `
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="definirEnderecoPadrao(${index})">
                                    Definir como Padrão
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-outline-danger" onclick="confirmarRemoverEndereco(${index})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            listaEnderecos.appendChild(enderecoCard);
        });
    }

    // Salvar dados pessoais
    function salvarDadosPessoais(event) {
        event.preventDefault();

        fetch('/api/cliente/auth/status')
            .then(response => response.json())
            .then(data => {
                if (!data.autenticado) {
                    window.location.href = '/loja/login-cliente';
                    throw new Error('Sessão expirada');
                }

                const dadosAtualizados = {
                    nome: document.getElementById('nome').value,
                    email: document.getElementById('email').value,
                    cpf: document.getElementById('cpf').value,
                    dataNascimento: document.getElementById('dataNascimento').value,
                    genero: document.getElementById('genero').value,
                    enderecoFaturamento: dadosCliente.enderecoFaturamento,
                    senha: "manterSenhaAtual"
                };

                return fetch('/api/cliente/atualizar', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosAtualizados)
                });
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        try {
                            const errorData = JSON.parse(text);
                            throw new Error(errorData.message || 'Erro desconhecido');
                        } catch {
                            throw new Error('Erro ao processar resposta: ' + text);
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                dadosCliente = data;
                mostrarSucesso('Dados pessoais atualizados com sucesso!');
            })
            .catch(error => {
                console.error('Erro ao atualizar dados:', error);
                try {
                    if (error.message) {
                        mostrarErro(error.message);
                    } else {
                        mostrarErro('Erro ao atualizar seus dados. Por favor, tente novamente.');
                    }
                } catch {
                    mostrarErro('Erro ao atualizar seus dados. Por favor, tente novamente.');
                }
            });
    }

    // Alterar senha
    function alterarSenha(event) {
        event.preventDefault();

        const senhaAtual = document.getElementById('senhaAtual').value;
        const novaSenha = document.getElementById('novaSenha').value;
        const confirmarSenha = document.getElementById('confirmarSenha').value;

        if (novaSenha !== confirmarSenha) {
            mostrarErro('As senhas não conferem!');
            return;
        }

        fetch('/api/cliente/auth/status')
            .then(response => response.json())
            .then(data => {
                if (!data.autenticado) {
                    window.location.href = '/loja/login-cliente';
                    throw new Error('Sessão expirada');
                }

                const dadosAtualizados = { senha: novaSenha };

                return fetch('/api/cliente/atualizar', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dadosAtualizados)
                });
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        try {
                            const errorData = JSON.parse(text);
                            throw new Error(errorData.message || 'Erro desconhecido');
                        } catch {
                            throw new Error('Erro ao processar resposta: ' + text);
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('formSenha').reset();
                mostrarSucesso('Senha alterada com sucesso!');
            })
            .catch(error => {
                console.error('Erro ao alterar senha:', error);
                try {
                    if (error.message) {
                        mostrarErro(error.message);
                    } else {
                        mostrarErro('Erro ao alterar sua senha. Por favor, tente novamente.');
                    }
                } catch {
                    mostrarErro('Erro ao alterar sua senha. Por favor, tente novamente.');
                }
            });
    }

    // Buscar CEP usando a API ViaCEP
    function buscarCep() {
        const cep = document.getElementById('cep').value.replace(/\D/g, '');

        if (cep.length !== 8) {
            return;
        }

        fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then(response => response.json())
            .then(data => {
                if (data.erro) {
                    mostrarErro('CEP não encontrado.');
                    return;
                }
                document.getElementById('logradouro').value = data.logradouro;
                document.getElementById('bairro').value = data.bairro;
                document.getElementById('cidade').value = data.localidade;
                document.getElementById('uf').value = data.uf;
                document.getElementById('numero').focus();
            })
            .catch(error => {
                console.error('Erro ao buscar CEP:', error);
                mostrarErro('Erro ao buscar o CEP. Por favor, tente novamente.');
            });
    }

    // Salvar novo endereço
    function salvarNovoEndereco() {
        const form = document.getElementById('formNovoEndereco');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        fetch('/api/cliente/auth/status')
            .then(response => response.json())
            .then(data => {
                if (!data.autenticado) {
                    window.location.href = '/loja/login-cliente';
                    throw new Error('Sessão expirada');
                }

                const cep = document.getElementById('cep').value;
                const logradouro = document.getElementById('logradouro').value;
                const numero = document.getElementById('numero').value;
                const complemento = document.getElementById('complemento').value;
                const bairro = document.getElementById('bairro').value;
                const cidade = document.getElementById('cidade').value;
                const uf = document.getElementById('uf').value;
                const padrao = document.getElementById('enderecoPadrao').checked;

                const enderecoCompleto = `${logradouro}, ${numero}${complemento ? `, ${complemento}` : ''} - ${bairro} - ${cidade}/${uf} - CEP: ${cep}`;
                const enderecoDTO = { endereco: enderecoCompleto, padrao: padrao };

                return fetch('/api/cliente/endereco', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(enderecoDTO)
                });
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        try {
                            const errorData = JSON.parse(text);
                            throw new Error(errorData.message || 'Erro desconhecido');
                        } catch {
                            throw new Error('Erro ao processar resposta: ' + text);
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                modalNovoEndereco.hide();
                form.reset();
                if (data.enderecosEntrega && data.enderecosEntrega.length > 0) {
                    renderizarEnderecos(data.enderecosEntrega);
                    if (data.padrao) {
                        definirEnderecoPadrao(data.enderecosEntrega.length - 1);
                    }
                }
                mostrarSucesso('Endereço adicionado com sucesso!');
            })
            .catch(error => {
                console.error('Erro ao adicionar endereço:', error);
                try {
                    if (error.message) {
                        mostrarErro(error.message);
                    } else {
                        mostrarErro('Erro ao adicionar endereço. Por favor, tente novamente.');
                    }
                } catch {
                    mostrarErro('Erro ao adicionar endereço. Por favor, tente novamente.');
                }
            });
    }

    // Confirmar remoção de endereço
    function confirmarRemoverEndereco(index) {
        document.getElementById('mensagemConfirmacao').textContent =
            'Tem certeza que deseja remover este endereço?';
        document.getElementById('btnConfirmar').onclick = function () {
            removerEndereco(index);
            modalConfirmacao.hide();
        };
        modalConfirmacao.show();
    }

    // Remover endereço
    function removerEndereco(index) {
        fetch('/api/cliente/auth/status')
            .then(response => response.json())
            .then(data => {
                if (!data.autenticado) {
                    window.location.href = '/loja/login-cliente';
                    throw new Error('Sessão expirada');
                }
                return fetch(`/api/cliente/endereco/${index}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        try {
                            const errorData = JSON.parse(text);
                            throw new Error(errorData.message || 'Erro desconhecido');
                        } catch {
                            throw new Error('Erro ao processar resposta: ' + text);
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                renderizarEnderecos(data.enderecosEntrega);
                mostrarSucesso('Endereço removido com sucesso!');
            })
            .catch(error => {
                console.error('Erro ao remover endereço:', error);
                try {
                    if (error.message) {
                        mostrarErro(error.message);
                    } else {
                        mostrarErro('Erro ao remover endereço. Por favor, tente novamente.');
                    }
                } catch {
                    mostrarErro('Erro ao remover endereço. Por favor, tente novamente.');
                }
            });
    }

    // Definir endereço como padrão
    function definirEnderecoPadrao(index) {
        fetch('/api/cliente/auth/status')
            .then(response => response.json())
            .then(data => {
                if (!data.autenticado) {
                    window.location.href = '/loja/login-cliente';
                    throw new Error('Sessão expirada');
                }
                return fetch(`/api/cliente/endereco/${index}/padrao`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' }
                });
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        try {
                            const errorData = JSON.parse(text);
                            throw new Error(errorData.message || 'Erro desconhecido');
                        } catch {
                            throw new Error('Erro ao processar resposta: ' + text);
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                renderizarEnderecos(data.enderecosEntrega);
                mostrarSucesso('Endereço padrão definido com sucesso!');
            })
            .catch(error => {
                console.error('Erro ao definir endereço padrão:', error);
                try {
                    if (error.message) {
                        mostrarErro(error.message);
                    } else {
                        mostrarErro('Erro ao definir endereço padrão. Por favor, tente novamente.');
                    }
                } catch {
                    mostrarErro('Erro ao definir endereço padrão. Por favor, tente novamente.');
                }
            });
    }

    // Carregar “Meus Pedidos” apenas na primeira vez que o usuário clicar na aba
    function carregarMeusPedidos() {
        if (pedidosJaCarregados) return;
        pedidosJaCarregados = true;

        // Exibe o spinner, esconde conteúdo e mensagem “nenhum pedido”
        document.getElementById('spinnerPedidos').style.display = 'block';
        document.getElementById('conteudoPedidos').style.display = 'none';
        document.getElementById('naoTemPedidos').style.display = 'none';

        fetch('/api/cliente/pedidos')
            .then(response => {
                console.log('Response status carregarMeusPedidos:', response.status);
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/loja/login-cliente';
                        throw new Error('Usuário não autenticado');
                    }
                    return response.text().then(text => {
                        try {
                            const errorData = JSON.parse(text);
                            throw new Error(errorData.message || 'Erro desconhecido');
                        } catch {
                            throw new Error('Erro ao processar resposta: ' + text);
                        }
                    });
                }
                return response.json();
            })
            .then(pedidos => {
                // Se não há pedidos
                if (!pedidos || pedidos.length === 0) {
                    document.getElementById('spinnerPedidos').style.display = 'none';
                    document.getElementById('naoTemPedidos').style.display = 'block';
                    return;
                }
                const tbody = document.getElementById('corpoTabelaPedidos');
                tbody.innerHTML = '';

                pedidos.forEach(pedido => {
                    const tr = document.createElement('tr');

                    // Número do pedido
                    const tdNumero = document.createElement('td');
                    tdNumero.textContent = pedido.numeroPedido || '-';
                    tr.appendChild(tdNumero);

                    // Data de criação (formata ISO para dd/mm/aaaa)
                    const tdData = document.createElement('td');
                    if (pedido.dataCriacao) {
                        const d = new Date(pedido.dataCriacao);
                        const dia = String(d.getDate()).padStart(2, '0');
                        const mes = String(d.getMonth() + 1).padStart(2, '0');
                        const ano = d.getFullYear();
                        tdData.textContent = `${dia}/${mes}/${ano}`;
                    } else {
                        tdData.textContent = '-';
                    }
                    tr.appendChild(tdData);

                    // Status
                    const tdStatus = document.createElement('td');
                    tdStatus.textContent = pedido.status || '-';
                    tr.appendChild(tdStatus);

                    // Total
                    const tdTotal = document.createElement('td');
                    tdTotal.textContent = pedido.total != null ? pedido.total.toFixed(2) : '-';
                    tr.appendChild(tdTotal);

                    // Ações (ex: link para detalhes)
                    const tdAcoes = document.createElement('td');
                    tdAcoes.innerHTML = `<a href="/loja/pedido/${pedido.numeroPedido}" class="btn btn-sm btn-primary">Ver Detalhes</a>`;
                    tr.appendChild(tdAcoes);

                    tbody.appendChild(tr);
                });

                // Exibe a tabela
                document.getElementById('spinnerPedidos').style.display = 'none';
                document.getElementById('conteudoPedidos').style.display = 'block';
            })
            .catch(error => {
                console.error('Erro ao carregar pedidos:', error);
                mostrarErro('Não foi possível obter seus pedidos. Tente novamente mais tarde.');
                document.getElementById('spinnerPedidos').style.display = 'none';
            });
    }

    // Fazer logout
    function fazerLogout() {
        fetch('/api/cliente/auth/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(response => {
                console.log('Response status fazerLogout:', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        try {
                            const errorData = JSON.parse(text);
                            throw new Error(errorData.message || 'Erro desconhecido');
                        } catch {
                            throw new Error('Erro ao processar resposta: ' + text);
                        }
                    });
                }
                return response.json();
            })
            .then(data => {
                window.location.href = '/loja';
            })
            .catch(error => {
                console.error('Erro ao fazer logout:', error);
                try {
                    if (error.message) {
                        alert(error.message);
                    } else {
                        alert('Erro ao fazer logout. Por favor, tente novamente.');
                    }
                } catch {
                    alert('Erro ao fazer logout. Por favor, tente novamente.');
                }
                window.location.href = '/loja';
            });
    }
</script>
</body>

</html>
